<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  th:replace="~{fragments/layout :: layout(~{::#conteudo}, 'Meu Perfil - Aprenda+')}"
>
  <body>
    <div id="conteudo">
      <!-- Hero -->
      <div class="dashboard-hero card mb-4">
        <div class="card-body p-4">
          <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
            <div>
              <div class="badge-level mb-2">
                <i class="fas fa-user-graduate"></i> Minha √Årea de Aluno
              </div>
              <h1 class="fw-bold mb-1">
                Ol√°, <span th:text="${usuario.nome}">Usu√°rio</span> üëã
              </h1>
              <p class="mb-2" th:text="${usuario.email}">email</p>
              <p class="mb-0">
                Ajuste seus dados pessoais, acompanhe seus pontos e personalize suas √°reas favoritas.
              </p>
            </div>
            <div class="text-lg-end align-self-center">
              <span class="badge bg-warning text-dark fs-5 px-3 py-2">
                <i class="fas fa-star"></i>
                <span th:text="${stats != null ? stats.pontos : 0}">0</span> pts
              </span>
            </div>
          </div>
        </div>
      </div>

      <div
        th:if="${erro}"
        class="alert alert-danger alert-dismissible fade show"
      >
        <span th:text="${erro}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <div
        th:if="${sucesso}"
        class="alert alert-success alert-dismissible fade show"
      >
        <span th:text="${sucesso}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <div class="surface-section mb-4" th:if="${stats != null}">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="metric-card d-flex align-items-center">
              <div class="metric-icon bg-primary text-white">
                <i class="fas fa-star"></i>
              </div>
              <div>
                <p class="text-muted mb-1">Pontos acumulados</p>
                <h3 class="mb-0" th:text="${stats.pontos}">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="metric-card d-flex align-items-center">
              <div class="metric-icon bg-success text-white">
                <i class="fas fa-book-open"></i>
              </div>
              <div>
                <p class="text-muted mb-1">Cursos em andamento</p>
                <h3 class="mb-0" th:text="${stats.cursosEmAndamento}">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="metric-card d-flex align-items-center">
              <div class="metric-icon bg-warning text-dark">
                <i class="fas fa-trophy"></i>
              </div>
              <div>
                <p class="text-muted mb-1">Desafios conclu√≠dos</p>
                <h3 class="mb-0" th:text="${stats.desafiosCompletos}">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="surface-section mb-4">
        <div class="row g-4">
        <!-- Informa√ß√µes Pessoais -->
        <div class="col-lg-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
              <h5 class="mb-0 section-title">
                <i class="fas fa-user-edit text-primary"></i> Informa√ß√µes pessoais
              </h5>
            </div>
            <div class="card-body">
              <form th:action="@{/perfil/atualizar}" method="post">
                <div class="mb-3">
                  <label for="nome" class="form-label">Nome</label>
                  <input
                    type="text"
                    class="form-control"
                    id="nome"
                    name="nome"
                    th:value="${usuario.nome}"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    th:value="${usuario.email}"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="senha" class="form-label"
                    >Nova Senha (deixe em branco para n√£o alterar)</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="senha"
                    name="senha"
                    placeholder="M√≠nimo 6 caracteres"
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>

                <input
                  type="hidden"
                  th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}"
                />
              </form>
            </div>
          </div>
        </div>

        <!-- Sistema de N√≠veis Gamificado -->
        <div class="col-lg-6" th:if="${stats != null && stats.nivelInfo != null}">
          <div class="card border-0 shadow-lg h-100"
            th:style="'background: linear-gradient(135deg, ' + ${stats.nivelInfo.nivelAtual.cor} + '15 0%, ' + ${stats.nivelInfo.nivelAtual.cor} + '05 100%);'">
            <div class="card-header bg-transparent border-0 pb-0">
              <h5 class="mb-0 section-title text-white">
                <i class="fas fa-trophy text-warning"></i> N√≠vel e ranking
              </h5>
            </div>
            <div class="card-body text-center text-white">
              <!-- Badge de N√≠vel -->
              <div
                class="nivel-badge mb-3"
                th:style="'background: linear-gradient(135deg, ' + ${stats.nivelInfo.nivelAtual.cor} + ' 0%, ' + ${stats.nivelInfo.nivelAtual.cor} + 'CC 100%);'"
                style="
                  width: 100px;
                  height: 100px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  margin: 0 auto;
                  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
                  animation: pulse 2s infinite;
                "
              >
                <div class="text-white text-center">
                  <div
                    class="display-3"
                    th:text="${stats.nivelInfo.nivelAtual.icone}"
                  >
                    ü•â
                  </div>
                  <div
                    class="h6 mb-0 fw-bold"
                    th:text="${stats.nivelInfo.nivelAtual.nome}"
                  >
                    Bronze
                  </div>
              </div>
              </div>

              <!-- Pontos -->
              <div class="mb-3">
                <h3 class="mb-1 fw-bold" th:text="${stats.pontos}">0</h3>
                <p class="text-muted mb-0">Pontos Totais</p>
              </div>

              <!-- Barra de Progresso para Pr√≥ximo N√≠vel -->
              <div class="mb-3" th:if="${stats.nivelInfo.proximoNivel != null}">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <small class="text-muted"
                    >Progresso para
                    <span th:text="${stats.nivelInfo.proximoNivel.nome}"
                      >Prata</span
                    ></small
                  >
                  <small
                    class="text-muted fw-bold"
                    th:text="${stats.nivelInfo.progresso} + '%'"
                    >42%</small
                  >
              </div>
                <div
                  class="progress"
                  style="
                    height: 25px;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
                  "
                >
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated fw-bold text-white d-flex align-items-center justify-content-center"
                    th:style="'width: ' + ${stats.nivelInfo.progresso} + '%; background: linear-gradient(90deg, ' + ${stats.nivelInfo.nivelAtual.cor} + ' 0%, ' + ${stats.nivelInfo.proximoNivel.cor} + ' 100%);'"
                    th:text="${stats.nivelInfo.progresso} + '%'"
                    role="progressbar"
                  >
                    42%
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  <i class="fas fa-fire text-warning"></i>
                  Faltam
                  <strong th:text="${stats.nivelInfo.pontosParaProximo}"
                    >100</strong
                  >
                  pontos para
                  <span th:text="${stats.nivelInfo.proximoNivel.nome}"
                    >Prata</span
                  >!
                </small>
              </div>

              <!-- N√≠vel M√°ximo -->
              <div class="mb-3" th:if="${stats.nivelInfo.proximoNivel == null}">
                <div class="alert alert-success mb-0">
                  <i class="fas fa-crown"></i>
                  <strong>N√≠vel M√°ximo Alcan√ßado!</strong>
                  <p class="mb-0 small">
                    Parab√©ns! Voc√™ alcan√ßou o n√≠vel Lend√°rio!
                  </p>
                </div>
              </div>
        </div>
        </div>
      </div>

      <!-- Minha √°rea de aluno -->
      <div class="surface-section mb-4">
        <div class="row g-4">
          <div class="col-lg-7">
            <h4 class="section-title mb-3">
              <i class="fas fa-play-circle text-info"></i> Cursos em andamento
            </h4>
            <div th:if="${cursosAtivos != null and !cursosAtivos.empty}" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden">
              <div class="list-group-item p-3" th:each="inscricao : ${cursosAtivos}">
                <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
                  <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <div class="fs-3" th:text="${inscricao.curso.icone != null ? inscricao.curso.icone : 'üìö'}">üìö</div>
                    <div>
                      <h6 class="mb-1" th:text="${inscricao.curso.titulo}">Curso</h6>
                      <p class="text-muted small mb-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary me-1" th:text="${inscricao.curso.area}">√Årea</span>
                        <span class="badge bg-dark text-white" th:text="${inscricao.curso.nivel}">N√≠vel</span>
                      </p>
                      <div class="progress" style="height: 10px; border-radius: 999px;">
                        <div class="progress-bar bg-success" th:style="'width:' + ${inscricao.progresso} + '%;'" th:text="${inscricao.progresso} + '%'">45%</div>
                      </div>
                    </div>
                  </div>
                  <div>
                    <a class="btn btn-sm btn-primary" th:href="@{/cursos/{id}(id=${inscricao.curso.id})}">
                      Continuar
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <div th:if="${cursosAtivos == null or cursosAtivos.empty}" class="alert alert-info mb-0">
              Nenhum curso em andamento. Explore novos conte√∫dos na √°rea de cursos!
            </div>
          </div>
          <div class="col-lg-5">
            <h4 class="section-title mb-3">
              <i class="fas fa-route text-success"></i> Trilhas inscritas
            </h4>
            <div th:if="${trilhasUsuario != null and !trilhasUsuario.empty}" class="vstack gap-3">
              <div class="card border-0 shadow-sm" th:each="usuarioTrilha : ${trilhasUsuario}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1" th:text="${usuarioTrilha.trilha.titulo}">Trilha</h6>
                      <p class="text-muted small mb-0" th:text="${usuarioTrilha.trilha.descricao}">desc</p>
                    </div>
                    <span class="badge bg-primary bg-opacity-10 text-primary" th:text="${usuarioTrilha.trilha.area}">√Årea</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      Inscrito em
                      <span th:text="${#temporals.format(usuarioTrilha.inscritoEm, 'dd/MM/yyyy')}">data</span>
                    </small>
                    <a class="btn btn-sm btn-outline-primary" th:href="@{/trilhas/{id}(id=${usuarioTrilha.trilha.id})}">
                      Ver trilha
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <div th:if="${trilhasUsuario == null or trilhasUsuario.empty}" class="alert alert-light border border-dashed text-muted mb-0">
              Ainda sem trilhas. Escolha uma trilha para seguir um caminho guiado.
            </div>
          </div>
        </div>
      </div>

      <!-- Hist√≥rico -->
      <div class="surface-section mb-4">
        <div class="row g-4">
          <div class="col-lg-6">
            <h4 class="section-title mb-3">
              <i class="fas fa-medal text-warning"></i> Cursos conclu√≠dos
            </h4>
            <div th:if="${cursosConcluidos != null and !cursosConcluidos.empty}" class="vstack gap-3">
              <div class="card border-0 shadow-sm" th:each="inscricao : ${cursosConcluidos}">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1" th:text="${inscricao.curso.titulo}">Curso</h6>
                    <small class="text-muted">
                      Finalizado em
                      <span th:text="${inscricao.concluidoEm != null ? #temporals.format(inscricao.concluidoEm, 'dd/MM/yyyy') : '-'}">data</span>
                    </small>
        </div>
                  <span class="badge bg-success bg-opacity-10 text-success">
                    <i class="fas fa-check-circle"></i> 100%
                  </span>
                </div>
              </div>
            </div>
            <div th:if="${cursosConcluidos == null or cursosConcluidos.empty}" class="alert alert-info mb-0">
              Complete um curso para liberar certificados aqui.
            </div>
          </div>
          <div class="col-lg-6">
            <h4 class="section-title mb-3">
              <i class="fas fa-gamepad text-primary"></i> Desafios conclu√≠dos
            </h4>
            <div th:if="${desafiosConcluidos != null and !desafiosConcluidos.empty}" class="timeline">
              <div class="timeline-item" th:each="registro : ${desafiosConcluidos}">
                <div class="timeline-point bg-primary"></div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-1" th:text="${registro.desafio.titulo}">Desafio</h6>
                    <small class="text-muted" th:text="${#temporals.format(registro.concluidoEm, 'dd/MM/yyyy HH:mm')}">data</small>
                  </div>
                  <p class="text-muted small mb-1" th:text="${registro.desafio.descricao}">desc</p>
                  <div class="d-flex gap-3 small">
                    <span class="text-success">
                      <i class="fas fa-star"></i>
                      +<span th:text="${registro.pontosGanhos}">25</span> pts
                    </span>
                    <span>
                      <strong th:text="${registro.pontuacao}">3</strong>/<span th:text="${registro.totalPerguntas}">5</span> acertos
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div th:if="${desafiosConcluidos == null or desafiosConcluidos.empty}" class="alert alert-light border border-dashed text-muted mb-0">
              Conclua um desafio para ver seus resultados aqui.
            </div>
          </div>
        </div>
      </div>

      <div class="surface-section">
        <div class="row g-4 mt-1">
        <!-- √Åreas -->
        <div class="col-lg-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 section-title">
                <i class="fas fa-heart text-danger"></i> √Åreas de interesse
              </h5>
              <button class="btn btn-outline-primary btn-sm" id="btnEditarAreas" type="button">
                <i class="fas fa-edit"></i> Editar
              </button>
            </div>
            <div class="card-body">
              <div id="visualizacaoAreas">
                <div th:if="${areasSelecionadas != null && !areasSelecionadas.empty}">
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary p-2"
                      th:each="entry : ${areasSelecionadas.entrySet()}">
                      <span th:text="${todasAreas[entry.key] != null ? todasAreas[entry.key] : entry.key}">√Årea</span> ¬∑
                      <strong th:text="${entry.value}">N√≠vel</strong>
                    </span>
                  </div>
                </div>
                <div th:if="${areasSelecionadas == null || areasSelecionadas.empty}">
                  <p class="text-muted">Nenhuma √°rea cadastrada. Clique em editar para selecionar suas prefer√™ncias.</p>
                </div>
              </div>
              <div id="edicaoAreas" style="display:none">
                <form th:action="@{/perfil/preferencias}" method="post" class="mt-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <p class="text-muted mb-0">
                      Selecione at√© 3 √°reas e informe o n√≠vel de experi√™ncia em cada uma.
                    </p>
                    <span class="badge bg-primary-subtle text-primary">
                      <i class="fas fa-hashtag"></i>
                      <span id="contadorAreas">0/3</span>
                    </span>
                  </div>
                  <div id="limiteAreasAviso" class="alert alert-warning py-2 px-3 d-none">
                    Voc√™ atingiu o limite de 3 √°reas. Desmarque alguma op√ß√£o para escolher outra.
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3" th:each="entry : ${todasAreas}" th:with="areaKey=${entry.key}">
                      <div class="card h-100 area-card">
                        <div class="card-body">
                          <div class="form-check mb-2">
                            <input class="form-check-input"
                              type="checkbox"
                              name="areasSelecionadas"
                              th:id="'area-' + ${areaKey}"
                              th:value="${areaKey}"
                              th:checked="${areasSelecionadas.containsKey(areaKey)}">
                            <label class="form-check-label fw-bold" th:for="'area-' + ${areaKey}">
                              <span th:text="${entry.value}">√Årea</span>
                            </label>
                          </div>
                          <label class="form-label small mb-1">N√≠vel</label>
                          <select class="form-select form-select-sm"
                            th:id="'nivel-' + ${areaKey}"
                            th:name="${'nivel_' + areaKey}">
                            <option value="Iniciante"
                              th:selected="${areasSelecionadas[areaKey] == 'Iniciante'}">
                              Iniciante
                            </option>
                            <option value="Intermedi√°rio"
                              th:selected="${areasSelecionadas[areaKey] == 'Intermedi√°rio'}">
                              Intermedi√°rio
                            </option>
                            <option value="Avan√ßado"
                              th:selected="${areasSelecionadas[areaKey] == 'Avan√ßado'}">
                              Avan√ßado
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-success">
                      <i class="fas fa-save"></i> Salvar
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="btnCancelarAreas">
                      Cancelar
                    </button>
                  </div>
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </form>
              </div>
          </div>
        </div>
      </div>

      <!-- Trof√©us -->
        <div class="col-lg-6">
          <div class="card shadow-sm border-0 h-100" th:if="${trofeus != null and !trofeus.empty}">
            <div class="card-header bg-white border-0">
              <h5 class="mb-0 section-title">
                <i class="fas fa-trophy text-warning"></i> Meus trof√©us
          </h5>
        </div>
        <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6" th:each="trofeu : ${trofeus}">
                  <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                  <h1 class="display-4" th:text="${trofeu.trofeu.icone}">üèÜ</h1>
                      <h6 class="fw-bold" th:text="${trofeu.trofeu.nome}">Trof√©u</h6>
                      <p class="text-muted small" th:text="${trofeu.trofeu.descricao}">desc</p>
                  <small class="text-muted" th:if="${trofeu.conquistadoEm}">
                        Conquistado em
                        <span th:text="${#temporals.format(trofeu.conquistadoEm, 'dd/MM/yyyy')}">data</span>
                  </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="alert alert-info h-100" th:if="${trofeus == null or trofeus.empty}">
            Nenhum trof√©u ainda. Complete desafios para desbloquear conquistas!
          </div>
        </div>
      </div>
      </div>

      <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener("DOMContentLoaded", function () {
          const visualizacao = document.getElementById("visualizacaoAreas");
          const edicao = document.getElementById("edicaoAreas");
          const btnEditar = document.getElementById("btnEditarAreas");
          const btnCancelar = document.getElementById("btnCancelarAreas");
          const contador = document.getElementById("contadorAreas");
          const avisoLimite = document.getElementById("limiteAreasAviso");
          const maxAreas = 3;
          const checkboxes = Array.from(
            document.querySelectorAll('input[name="areasSelecionadas"]')
          );

          function toggleEdicao(mostrar) {
            if (!visualizacao || !edicao) return;
            if (mostrar) {
              visualizacao.style.display = "none";
              edicao.style.display = "block";
              btnEditar?.classList.add("d-none");
            } else {
              visualizacao.style.display = "block";
              edicao.style.display = "none";
              btnEditar?.classList.remove("d-none");
            }
          }

          function atualizarSelecoes() {
            const selecionadas = checkboxes.filter((cb) => cb.checked);
            if (contador) contador.textContent = `${selecionadas.length}/${maxAreas}`;

            checkboxes.forEach((cb) => {
              const select = document.getElementById(`nivel-${cb.value}`);
              if (select) select.disabled = !cb.checked;
            });

            if (selecionadas.length >= maxAreas) {
              avisoLimite?.classList.remove("d-none");
              checkboxes.forEach((cb) => {
                if (!cb.checked) cb.disabled = true;
              });
            } else {
              avisoLimite?.classList.add("d-none");
              checkboxes.forEach((cb) => (cb.disabled = false));
            }
          }

          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", (event) => {
              if (event.target.checked) {
                const selecionadas = checkboxes.filter((cb) => cb.checked);
                if (selecionadas.length > maxAreas) {
                  event.target.checked = false;
                  return;
                }
              }
              atualizarSelecoes();
            });
          });

          btnEditar?.addEventListener("click", () => {
            toggleEdicao(true);
            atualizarSelecoes();
          });
          btnCancelar?.addEventListener("click", () => toggleEdicao(false));

          atualizarSelecoes();
        });
        /*]]>*/
      </script>
    </div>
  </body>
</html>
