# Azure Pipeline YAML para Build e Deploy
# Pipeline de CI/CD para o projeto Aprenda+

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: "ubuntu-latest"

variables:
  mavenVersion: "3.9.5"
  javaVersion: "21"
  resourceGroup: "rg-aprenda-plus"
  webAppName: "aprenda-plus"

stages:
  - stage: Build
    displayName: "Build e Testes"
    jobs:
      - job: BuildJob
        displayName: "Compilar e Testar"
        steps:
          - task: JavaToolInstaller@0
            inputs:
              versionSpec: "$(javaVersion)"
              jdkArchitecture: "x64"
              jdkSource: "PreInstalled"

          - task: Maven@4
            displayName: "Maven Build"
            inputs:
              mavenPomFile: "pom.xml"
              goals: "clean package"
              options: "-DskipTests=false"
              publishJUnitResults: true
              testResultsFiles: "**/surefire-reports/TEST-*.xml"
              javaHomeOption: "JDKVersion"
              jdkVersionOption: "$(javaVersion)"
              jdkArchitectureOption: "x64"

          - task: PublishTestResults@2
            displayName: "Publicar Resultados dos Testes"
            inputs:
              testResultsFormat: "JUnit"
              testResultsFiles: "**/TEST-*.xml"
              failTaskOnFailedTests: true

          - task: PublishCodeCoverageResults@1
            displayName: "Publicar Cobertura de Código"
            inputs:
              codeCoverageTool: "JaCoCo"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/site/jacoco/jacoco.xml"

          - task: PublishBuildArtifacts@1
            displayName: "Publicar Artefatos"
            inputs:
              PathtoPublish: "$(System.DefaultWorkingDirectory)/target/*.jar"
              ArtifactName: "drop"
              publishLocation: "Container"

  - stage: Deploy
    displayName: "Deploy para Azure"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: "Deploy Web App"
        environment: "production"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: "Deploy para Azure Web App"
                  inputs:
                    azureSubscription: "Azure-Service-Connection"
                    appName: "$(webAppName)"
                    package: "$(Pipeline.Workspace)/drop/*.jar"
                    runtimeStack: "JAVA|17"
                    startUpCommand: "java -jar app.jar"

                - task: AzureCLI@2
                  displayName: "Verificar Deploy"
                  inputs:
                    azureSubscription: "Azure-Service-Connection"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      echo "Verificando status da aplicação..."
                      az webapp show --name $(webAppName) --resource-group $(resourceGroup) --query state








